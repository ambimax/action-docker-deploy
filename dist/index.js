"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("os")),r=e(require("path")),o=e(require("events")),n=e(require("child_process")),i=e(require("util")),s=e(require("assert")),a=require("fs"),c=e(a),u=e(require("stream")),l=e(require("http")),d=e(require("url")),f=e(require("https")),h=e(require("zlib")),p="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function m(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function y(e,t){return e(t={exports:{}},t.exports),t.exports}var g=y((function(e,r){var o=p&&p.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(r,"__esModule",{value:!0});const n=o(t);function i(e,t,r){const o=new s(e,t,r);process.stdout.write(o.toString()+n.EOL)}r.issueCommand=i,r.issue=function(e,t=""){i(e,{},t)};class s{constructor(e,t,r){e||(e="missing.command"),this.command=e,this.properties=t,this.message=r}toString(){let e="::"+this.command;if(this.properties&&Object.keys(this.properties).length>0){e+=" ";let r=!0;for(const o in this.properties)if(this.properties.hasOwnProperty(o)){const n=this.properties[o];n&&(r?r=!1:e+=",",e+=`${o}=${t=n,(t||"").replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A").replace(/:/g,"%3A").replace(/,/g,"%2C")}`)}}var t;return e+=`::${function(e){return(e||"").replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A")}(this.message)}`,e}}}));m(g);g.issueCommand,g.issue;var b=y((function(e,o){var n=p&&p.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},i=p&&p.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(o,"__esModule",{value:!0});const s=i(t),a=i(r);var c;function u(e){g.issue("error",e)}function l(e){g.issue("group",e)}function d(){g.issue("endgroup")}!function(e){e[e.Success=0]="Success",e[e.Failure=1]="Failure"}(c=o.ExitCode||(o.ExitCode={})),o.exportVariable=function(e,t){process.env[e]=t,g.issueCommand("set-env",{name:e},t)},o.setSecret=function(e){g.issueCommand("add-mask",{},e)},o.addPath=function(e){g.issueCommand("add-path",{},e),process.env.PATH=`${e}${a.delimiter}${process.env.PATH}`},o.getInput=function(e,t){const r=process.env[`INPUT_${e.replace(/ /g,"_").toUpperCase()}`]||"";if(t&&t.required&&!r)throw new Error(`Input required and not supplied: ${e}`);return r.trim()},o.setOutput=function(e,t){g.issueCommand("set-output",{name:e},t)},o.setFailed=function(e){process.exitCode=c.Failure,u(e)},o.isDebug=function(){return"1"===process.env.RUNNER_DEBUG},o.debug=function(e){g.issueCommand("debug",{},e)},o.error=u,o.warning=function(e){g.issue("warning",e)},o.info=function(e){process.stdout.write(e+s.EOL)},o.startGroup=l,o.endGroup=d,o.group=function(e,t){return n(this,void 0,void 0,(function*(){let r;l(e);try{r=yield t()}finally{d()}return r}))},o.saveState=function(e,t){g.issueCommand("save-state",{name:e},t)},o.getState=function(e){return process.env[`STATE_${e}`]||""}}));m(b);b.ExitCode,b.exportVariable,b.setSecret,b.addPath;var w=b.getInput,v=(b.setOutput,b.setFailed),S=(b.isDebug,b.debug,b.error,b.warning,b.info,b.startGroup),E=b.endGroup,x=(b.group,b.saveState,b.getState,y((function(e,t){var o,n=p&&p.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};function i(e){return(1&e.mode)>0||(8&e.mode)>0&&e.gid===process.getgid()||(64&e.mode)>0&&e.uid===process.getuid()}Object.defineProperty(t,"__esModule",{value:!0}),o=c.promises,t.chmod=o.chmod,t.copyFile=o.copyFile,t.lstat=o.lstat,t.mkdir=o.mkdir,t.readdir=o.readdir,t.readlink=o.readlink,t.rename=o.rename,t.rmdir=o.rmdir,t.stat=o.stat,t.symlink=o.symlink,t.unlink=o.unlink,t.IS_WINDOWS="win32"===process.platform,t.exists=function(e){return n(this,void 0,void 0,(function*(){try{yield t.stat(e)}catch(e){if("ENOENT"===e.code)return!1;throw e}return!0}))},t.isDirectory=function(e,r=!1){return n(this,void 0,void 0,(function*(){return(r?yield t.stat(e):yield t.lstat(e)).isDirectory()}))},t.isRooted=function(e){if(!(e=function(e){if(e=e||"",t.IS_WINDOWS)return(e=e.replace(/\//g,"\\")).replace(/\\\\+/g,"\\");return e.replace(/\/\/+/g,"/")}(e)))throw new Error('isRooted() parameter "p" cannot be empty');return t.IS_WINDOWS?e.startsWith("\\")||/^[A-Z]:/i.test(e):e.startsWith("/")},t.mkdirP=function e(o,i=1e3,a=1){return n(this,void 0,void 0,(function*(){if(s.ok(o,"a path argument must be provided"),o=r.resolve(o),a>=i)return t.mkdir(o);try{return void(yield t.mkdir(o))}catch(n){switch(n.code){case"ENOENT":return yield e(r.dirname(o),i,a+1),void(yield t.mkdir(o));default:{let e;try{e=yield t.stat(o)}catch(e){throw n}if(!e.isDirectory())throw n}}}}))},t.tryGetExecutablePath=function(e,o){return n(this,void 0,void 0,(function*(){let n=void 0;try{n=yield t.stat(e)}catch(t){"ENOENT"!==t.code&&console.log(`Unexpected error attempting to determine if executable file exists '${e}': ${t}`)}if(n&&n.isFile())if(t.IS_WINDOWS){const t=r.extname(e).toUpperCase();if(o.some(e=>e.toUpperCase()===t))return e}else if(i(n))return e;const s=e;for(const a of o){e=s+a,n=void 0;try{n=yield t.stat(e)}catch(t){"ENOENT"!==t.code&&console.log(`Unexpected error attempting to determine if executable file exists '${e}': ${t}`)}if(n&&n.isFile()){if(t.IS_WINDOWS){try{const o=r.dirname(e),n=r.basename(e).toUpperCase();for(const i of yield t.readdir(o))if(n===i.toUpperCase()){e=r.join(o,i);break}}catch(t){console.log(`Unexpected error attempting to determine the actual case of the file '${e}': ${t}`)}return e}if(i(n))return e}}return""}))}})));m(x);x.chmod,x.copyFile,x.lstat,x.mkdir,x.readdir,x.readlink,x.rename,x.rmdir,x.stat,x.symlink,x.unlink,x.IS_WINDOWS,x.exists,x.isDirectory,x.isRooted,x.mkdirP,x.tryGetExecutablePath;var _=y((function(e,t){var o=p&&p.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=i.promisify(n.exec);function a(e){return o(this,void 0,void 0,(function*(){if(x.IS_WINDOWS){try{(yield x.isDirectory(e,!0))?yield s(`rd /s /q "${e}"`):yield s(`del /f /a "${e}"`)}catch(e){if("ENOENT"!==e.code)throw e}try{yield x.unlink(e)}catch(e){if("ENOENT"!==e.code)throw e}}else{let t=!1;try{t=yield x.isDirectory(e)}catch(e){if("ENOENT"!==e.code)throw e;return}t?yield s(`rm -rf "${e}"`):yield x.unlink(e)}}))}function c(e){return o(this,void 0,void 0,(function*(){yield x.mkdirP(e)}))}function u(e,t,r){return o(this,void 0,void 0,(function*(){if((yield x.lstat(e)).isSymbolicLink()){try{yield x.lstat(t),yield x.unlink(t)}catch(e){"EPERM"===e.code&&(yield x.chmod(t,"0666"),yield x.unlink(t))}const r=yield x.readlink(e);yield x.symlink(r,t,x.IS_WINDOWS?"junction":null)}else(yield x.exists(t))&&!r||(yield x.copyFile(e,t))}))}t.cp=function(e,t,n={}){return o(this,void 0,void 0,(function*(){const{force:i,recursive:s}=function(e){const t=null==e.force||e.force,r=Boolean(e.recursive);return{force:t,recursive:r}}(n),a=(yield x.exists(t))?yield x.stat(t):null;if(a&&a.isFile()&&!i)return;const l=a&&a.isDirectory()?r.join(t,r.basename(e)):t;if(!(yield x.exists(e)))throw new Error(`no such file or directory: ${e}`);if((yield x.stat(e)).isDirectory()){if(!s)throw new Error(`Failed to copy. ${e} is a directory, but tried to copy without recursive flag.`);yield function e(t,r,n,i){return o(this,void 0,void 0,(function*(){if(n>=255)return;n++,yield c(r);const o=yield x.readdir(t);for(const s of o){const o=`${t}/${s}`,a=`${r}/${s}`;(yield x.lstat(o)).isDirectory()?yield e(o,a,n,i):yield u(o,a,i)}yield x.chmod(r,(yield x.stat(t)).mode)}))}(e,l,0,i)}else{if(""===r.relative(e,l))throw new Error(`'${l}' and '${e}' are the same file`);yield u(e,l,i)}}))},t.mv=function(e,t,n={}){return o(this,void 0,void 0,(function*(){if(yield x.exists(t)){let o=!0;if((yield x.isDirectory(t))&&(t=r.join(t,r.basename(e)),o=yield x.exists(t)),o){if(null!=n.force&&!n.force)throw new Error("Destination already exists");yield a(t)}}yield c(r.dirname(t)),yield x.rename(e,t)}))},t.rmRF=a,t.mkdirP=c,t.which=function e(t,n){return o(this,void 0,void 0,(function*(){if(!t)throw new Error("parameter 'tool' is required");if(n){if(!(yield e(t,!1)))throw x.IS_WINDOWS?new Error(`Unable to locate executable file: ${t}. Please verify either the file path exists or the file can be found within a directory specified by the PATH environment variable. Also verify the file has a valid extension for an executable file.`):new Error(`Unable to locate executable file: ${t}. Please verify either the file path exists or the file can be found within a directory specified by the PATH environment variable. Also check the file mode to verify the file is executable.`)}try{const e=[];if(x.IS_WINDOWS&&process.env.PATHEXT)for(const t of process.env.PATHEXT.split(r.delimiter))t&&e.push(t);if(x.isRooted(t)){const r=yield x.tryGetExecutablePath(t,e);return r||""}if(t.includes("/")||x.IS_WINDOWS&&t.includes("\\"))return"";const o=[];if(process.env.PATH)for(const e of process.env.PATH.split(r.delimiter))e&&o.push(e);for(const n of o){const o=yield x.tryGetExecutablePath(n+r.sep+t,e);if(o)return o}return""}catch(e){throw new Error(`which failed with message ${e.message}`)}}))}}));m(_);_.cp,_.mv,_.rmRF,_.mkdirP,_.which;var P=y((function(e,i){var s=p&&p.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(i,"__esModule",{value:!0});const a="win32"===process.platform;class c extends o.EventEmitter{constructor(e,t,r){if(super(),!e)throw new Error("Parameter 'toolPath' cannot be null or empty.");this.toolPath=e,this.args=t||[],this.options=r||{}}_debug(e){this.options.listeners&&this.options.listeners.debug&&this.options.listeners.debug(e)}_getCommandString(e,t){const r=this._getSpawnFileName(),o=this._getSpawnArgs(e);let n=t?"":"[command]";if(a)if(this._isCmdFile()){n+=r;for(const e of o)n+=` ${e}`}else if(e.windowsVerbatimArguments){n+=`"${r}"`;for(const e of o)n+=` ${e}`}else{n+=this._windowsQuoteCmdArg(r);for(const e of o)n+=` ${this._windowsQuoteCmdArg(e)}`}else{n+=r;for(const e of o)n+=` ${e}`}return n}_processLineBuffer(e,r,o){try{let n=r+e.toString(),i=n.indexOf(t.EOL);for(;i>-1;){o(n.substring(0,i)),n=n.substring(i+t.EOL.length),i=n.indexOf(t.EOL)}r=n}catch(e){this._debug(`error processing line. Failed with error ${e}`)}}_getSpawnFileName(){return a&&this._isCmdFile()?process.env.COMSPEC||"cmd.exe":this.toolPath}_getSpawnArgs(e){if(a&&this._isCmdFile()){let t=`/D /S /C "${this._windowsQuoteCmdArg(this.toolPath)}`;for(const r of this.args)t+=" ",t+=e.windowsVerbatimArguments?r:this._windowsQuoteCmdArg(r);return t+='"',[t]}return this.args}_endsWith(e,t){return e.endsWith(t)}_isCmdFile(){const e=this.toolPath.toUpperCase();return this._endsWith(e,".CMD")||this._endsWith(e,".BAT")}_windowsQuoteCmdArg(e){if(!this._isCmdFile())return this._uvQuoteCmdArg(e);if(!e)return'""';const t=[" ","\t","&","(",")","[","]","{","}","^","=",";","!","'","+",",","`","~","|","<",">",'"'];let r=!1;for(const o of e)if(t.some(e=>e===o)){r=!0;break}if(!r)return e;let o='"',n=!0;for(let t=e.length;t>0;t--)o+=e[t-1],n&&"\\"===e[t-1]?o+="\\":'"'===e[t-1]?(n=!0,o+='"'):n=!1;return o+='"',o.split("").reverse().join("")}_uvQuoteCmdArg(e){if(!e)return'""';if(!e.includes(" ")&&!e.includes("\t")&&!e.includes('"'))return e;if(!e.includes('"')&&!e.includes("\\"))return`"${e}"`;let t='"',r=!0;for(let o=e.length;o>0;o--)t+=e[o-1],r&&"\\"===e[o-1]?t+="\\":'"'===e[o-1]?(r=!0,t+="\\"):r=!1;return t+='"',t.split("").reverse().join("")}_cloneExecOptions(e){const t={cwd:(e=e||{}).cwd||process.cwd(),env:e.env||process.env,silent:e.silent||!1,windowsVerbatimArguments:e.windowsVerbatimArguments||!1,failOnStdErr:e.failOnStdErr||!1,ignoreReturnCode:e.ignoreReturnCode||!1,delay:e.delay||1e4};return t.outStream=e.outStream||process.stdout,t.errStream=e.errStream||process.stderr,t}_getSpawnOptions(e,t){e=e||{};const r={};return r.cwd=e.cwd,r.env=e.env,r.windowsVerbatimArguments=e.windowsVerbatimArguments||this._isCmdFile(),e.windowsVerbatimArguments&&(r.argv0=`"${t}"`),r}exec(){return s(this,void 0,void 0,(function*(){return!x.isRooted(this.toolPath)&&(this.toolPath.includes("/")||a&&this.toolPath.includes("\\"))&&(this.toolPath=r.resolve(process.cwd(),this.options.cwd||process.cwd(),this.toolPath)),this.toolPath=yield _.which(this.toolPath,!0),new Promise((e,r)=>{this._debug(`exec tool: ${this.toolPath}`),this._debug("arguments:");for(const e of this.args)this._debug(`   ${e}`);const o=this._cloneExecOptions(this.options);!o.silent&&o.outStream&&o.outStream.write(this._getCommandString(o)+t.EOL);const i=new u(o,this.toolPath);i.on("debug",e=>{this._debug(e)});const s=this._getSpawnFileName(),a=n.spawn(s,this._getSpawnArgs(o),this._getSpawnOptions(this.options,s));a.stdout&&a.stdout.on("data",e=>{this.options.listeners&&this.options.listeners.stdout&&this.options.listeners.stdout(e),!o.silent&&o.outStream&&o.outStream.write(e),this._processLineBuffer(e,"",e=>{this.options.listeners&&this.options.listeners.stdline&&this.options.listeners.stdline(e)})});a.stderr&&a.stderr.on("data",e=>{if(i.processStderr=!0,this.options.listeners&&this.options.listeners.stderr&&this.options.listeners.stderr(e),!o.silent&&o.errStream&&o.outStream){(o.failOnStdErr?o.errStream:o.outStream).write(e)}this._processLineBuffer(e,"",e=>{this.options.listeners&&this.options.listeners.errline&&this.options.listeners.errline(e)})}),a.on("error",e=>{i.processError=e.message,i.processExited=!0,i.processClosed=!0,i.CheckComplete()}),a.on("exit",e=>{i.processExitCode=e,i.processExited=!0,this._debug(`Exit code ${e} received from tool '${this.toolPath}'`),i.CheckComplete()}),a.on("close",e=>{i.processExitCode=e,i.processExited=!0,i.processClosed=!0,this._debug(`STDIO streams have closed for tool '${this.toolPath}'`),i.CheckComplete()}),i.on("done",(t,o)=>{"".length>0&&this.emit("stdline",""),"".length>0&&this.emit("errline",""),a.removeAllListeners(),t?r(t):e(o)})})}))}}i.ToolRunner=c,i.argStringToArray=function(e){const t=[];let r=!1,o=!1,n="";function i(e){o&&'"'!==e&&(n+="\\"),n+=e,o=!1}for(let s=0;s<e.length;s++){const a=e.charAt(s);'"'!==a?"\\"===a&&o?i(a):"\\"===a&&r?o=!0:" "!==a||r?i(a):n.length>0&&(t.push(n),n=""):o?i(a):r=!r}return n.length>0&&t.push(n.trim()),t};class u extends o.EventEmitter{constructor(e,t){if(super(),this.processClosed=!1,this.processError="",this.processExitCode=0,this.processExited=!1,this.processStderr=!1,this.delay=1e4,this.done=!1,this.timeout=null,!t)throw new Error("toolPath must not be empty");this.options=e,this.toolPath=t,e.delay&&(this.delay=e.delay)}CheckComplete(){this.done||(this.processClosed?this._setResult():this.processExited&&(this.timeout=setTimeout(u.HandleTimeout,this.delay,this)))}_debug(e){this.emit("debug",e)}_setResult(){let e;this.processExited&&(this.processError?e=new Error(`There was an error when attempting to execute the process '${this.toolPath}'. This may indicate the process failed to start. Error: ${this.processError}`):0===this.processExitCode||this.options.ignoreReturnCode?this.processStderr&&this.options.failOnStdErr&&(e=new Error(`The process '${this.toolPath}' failed because one or more lines were written to the STDERR stream`)):e=new Error(`The process '${this.toolPath}' failed with exit code ${this.processExitCode}`)),this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.done=!0,this.emit("done",e,this.processExitCode)}static HandleTimeout(e){if(!e.done){if(!e.processClosed&&e.processExited){const t=`The STDIO streams did not close within ${e.delay/1e3} seconds of the exit event from process '${e.toolPath}'. This may indicate a child process inherited the STDIO streams and has not yet exited.`;e._debug(t)}e._setResult()}}}}));m(P);P.ToolRunner,P.argStringToArray;var O=y((function(e,t){var r=p&&p.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.exec=function(e,t,o){return r(this,void 0,void 0,(function*(){const r=P.argStringToArray(e);if(0===r.length)throw new Error("Parameter 'commandLine' cannot be null or empty.");const n=r[0];return t=r.slice(1).concat(t||[]),new P.ToolRunner(n,t,o).exec()}))}}));m(O);var T=O.exec;const $=u.Readable,C=Symbol("buffer"),k=Symbol("type");class j{constructor(){this[k]="";const e=arguments[0],t=arguments[1],r=[];let o=0;if(e){const t=e,n=Number(t.length);for(let e=0;e<n;e++){const n=t[e];let i;i=n instanceof Buffer?n:ArrayBuffer.isView(n)?Buffer.from(n.buffer,n.byteOffset,n.byteLength):n instanceof ArrayBuffer?Buffer.from(n):n instanceof j?n[C]:Buffer.from("string"==typeof n?n:String(n)),o+=i.length,r.push(i)}}this[C]=Buffer.concat(r);let n=t&&void 0!==t.type&&String(t.type).toLowerCase();n&&!/[^\u0020-\u007E]/.test(n)&&(this[k]=n)}get size(){return this[C].length}get type(){return this[k]}text(){return Promise.resolve(this[C].toString())}arrayBuffer(){const e=this[C],t=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);return Promise.resolve(t)}stream(){const e=new $;return e._read=function(){},e.push(this[C]),e.push(null),e}toString(){return"[object Blob]"}slice(){const e=this.size,t=arguments[0],r=arguments[1];let o,n;o=void 0===t?0:t<0?Math.max(e+t,0):Math.min(t,e),n=void 0===r?e:r<0?Math.max(e+r,0):Math.min(r,e);const i=Math.max(n-o,0),s=this[C].slice(o,o+i),a=new j([],{type:arguments[2]});return a[C]=s,a}}function A(e,t,r){Error.call(this,e),this.message=e,this.type=t,r&&(this.code=this.errno=r.code),Error.captureStackTrace(this,this.constructor)}let B;Object.defineProperties(j.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}}),Object.defineProperty(j.prototype,Symbol.toStringTag,{value:"Blob",writable:!1,enumerable:!1,configurable:!0}),A.prototype=Object.create(Error.prototype),A.prototype.constructor=A,A.prototype.name="FetchError";try{B=require("encoding").convert}catch(e){}const D=Symbol("Body internals"),L=u.PassThrough;function R(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=r.size;let n=void 0===o?0:o;var i=r.timeout;let s=void 0===i?0:i;null==e?e=null:F(e)?e=Buffer.from(e.toString()):N(e)||Buffer.isBuffer(e)||("[object ArrayBuffer]"===Object.prototype.toString.call(e)?e=Buffer.from(e):ArrayBuffer.isView(e)?e=Buffer.from(e.buffer,e.byteOffset,e.byteLength):e instanceof u||(e=Buffer.from(String(e)))),this[D]={body:e,disturbed:!1,error:null},this.size=n,this.timeout=s,e instanceof u&&e.on("error",(function(e){const r="AbortError"===e.name?e:new A(`Invalid response body while trying to fetch ${t.url}: ${e.message}`,"system",e);t[D].error=r}))}function I(){var e=this;if(this[D].disturbed)return R.Promise.reject(new TypeError(`body used already for: ${this.url}`));if(this[D].disturbed=!0,this[D].error)return R.Promise.reject(this[D].error);let t=this.body;if(null===t)return R.Promise.resolve(Buffer.alloc(0));if(N(t)&&(t=t.stream()),Buffer.isBuffer(t))return R.Promise.resolve(t);if(!(t instanceof u))return R.Promise.resolve(Buffer.alloc(0));let r=[],o=0,n=!1;return new R.Promise((function(i,s){let a;e.timeout&&(a=setTimeout((function(){n=!0,s(new A(`Response timeout while trying to fetch ${e.url} (over ${e.timeout}ms)`,"body-timeout"))}),e.timeout)),t.on("error",(function(t){"AbortError"===t.name?(n=!0,s(t)):s(new A(`Invalid response body while trying to fetch ${e.url}: ${t.message}`,"system",t))})),t.on("data",(function(t){if(!n&&null!==t){if(e.size&&o+t.length>e.size)return n=!0,void s(new A(`content size at ${e.url} over limit: ${e.size}`,"max-size"));o+=t.length,r.push(t)}})),t.on("end",(function(){if(!n){clearTimeout(a);try{i(Buffer.concat(r,o))}catch(t){s(new A(`Could not create Buffer from response body for ${e.url}: ${t.message}`,"system",t))}}}))}))}function F(e){return"object"==typeof e&&"function"==typeof e.append&&"function"==typeof e.delete&&"function"==typeof e.get&&"function"==typeof e.getAll&&"function"==typeof e.has&&"function"==typeof e.set&&("URLSearchParams"===e.constructor.name||"[object URLSearchParams]"===Object.prototype.toString.call(e)||"function"==typeof e.sort)}function N(e){return"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&"function"==typeof e.constructor&&"string"==typeof e.constructor.name&&/^(Blob|File)$/.test(e.constructor.name)&&/^(Blob|File)$/.test(e[Symbol.toStringTag])}function U(e){let t,r,o=e.body;if(e.bodyUsed)throw new Error("cannot clone body after it is used");return o instanceof u&&"function"!=typeof o.getBoundary&&(t=new L,r=new L,o.pipe(t),o.pipe(r),e[D].body=t,o=r),o}function q(e){return null===e?null:"string"==typeof e?"text/plain;charset=UTF-8":F(e)?"application/x-www-form-urlencoded;charset=UTF-8":N(e)?e.type||null:Buffer.isBuffer(e)||"[object ArrayBuffer]"===Object.prototype.toString.call(e)||ArrayBuffer.isView(e)?null:"function"==typeof e.getBoundary?`multipart/form-data;boundary=${e.getBoundary()}`:e instanceof u?null:"text/plain;charset=UTF-8"}function W(e){const t=e.body;return null===t?0:N(t)?t.size:Buffer.isBuffer(t)?t.length:t&&"function"==typeof t.getLengthSync&&(t._lengthRetrievers&&0==t._lengthRetrievers.length||t.hasKnownLength&&t.hasKnownLength())?t.getLengthSync():null}R.prototype={get body(){return this[D].body},get bodyUsed(){return this[D].disturbed},arrayBuffer(){return I.call(this).then((function(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}))},blob(){let e=this.headers&&this.headers.get("content-type")||"";return I.call(this).then((function(t){return Object.assign(new j([],{type:e.toLowerCase()}),{[C]:t})}))},json(){var e=this;return I.call(this).then((function(t){try{return JSON.parse(t.toString())}catch(t){return R.Promise.reject(new A(`invalid json response body at ${e.url} reason: ${t.message}`,"invalid-json"))}}))},text(){return I.call(this).then((function(e){return e.toString()}))},buffer(){return I.call(this)},textConverted(){var e=this;return I.call(this).then((function(t){return function(e,t){if("function"!=typeof B)throw new Error("The package `encoding` must be installed to use the textConverted() function");const r=t.get("content-type");let o,n,i="utf-8";r&&(o=/charset=([^;]*)/i.exec(r));n=e.slice(0,1024).toString(),!o&&n&&(o=/<meta.+?charset=(['"])(.+?)\1/i.exec(n));!o&&n&&(o=/<meta[\s]+?http-equiv=(['"])content-type\1[\s]+?content=(['"])(.+?)\2/i.exec(n),o&&(o=/charset=(.*)/i.exec(o.pop())));!o&&n&&(o=/<\?xml.+?encoding=(['"])(.+?)\1/i.exec(n));o&&(i=o.pop(),"gb2312"!==i&&"gbk"!==i||(i="gb18030"));return B(e,"UTF-8",i).toString()}(t,e.headers)}))}},Object.defineProperties(R.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0}}),R.mixIn=function(e){for(const t of Object.getOwnPropertyNames(R.prototype))if(!(t in e)){const r=Object.getOwnPropertyDescriptor(R.prototype,t);Object.defineProperty(e,t,r)}},R.Promise=global.Promise;const z=/[^\^_`a-zA-Z\-0-9!#$%&'*+.|~]/,H=/[^\t\x20-\x7e\x80-\xff]/;function M(e){if(e=`${e}`,z.test(e)||""===e)throw new TypeError(`${e} is not a legal HTTP header name`)}function G(e){if(e=`${e}`,H.test(e))throw new TypeError(`${e} is not a legal HTTP header value`)}function V(e,t){t=t.toLowerCase();for(const r in e)if(r.toLowerCase()===t)return r}const Q=Symbol("map");class K{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;if(this[Q]=Object.create(null),e instanceof K){const t=e.raw(),r=Object.keys(t);for(const e of r)for(const r of t[e])this.append(e,r)}else if(null==e);else{if("object"!=typeof e)throw new TypeError("Provided initializer must be an object");{const t=e[Symbol.iterator];if(null!=t){if("function"!=typeof t)throw new TypeError("Header pairs must be iterable");const r=[];for(const t of e){if("object"!=typeof t||"function"!=typeof t[Symbol.iterator])throw new TypeError("Each header pair must be iterable");r.push(Array.from(t))}for(const e of r){if(2!==e.length)throw new TypeError("Each header pair must be a name/value tuple");this.append(e[0],e[1])}}else for(const t of Object.keys(e)){const r=e[t];this.append(t,r)}}}}get(e){M(e=`${e}`);const t=V(this[Q],e);return void 0===t?null:this[Q][t].join(", ")}forEach(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,r=Z(this),o=0;for(;o<r.length;){var n=r[o];const i=n[0],s=n[1];e.call(t,s,i,this),r=Z(this),o++}}set(e,t){t=`${t}`,M(e=`${e}`),G(t);const r=V(this[Q],e);this[Q][void 0!==r?r:e]=[t]}append(e,t){t=`${t}`,M(e=`${e}`),G(t);const r=V(this[Q],e);void 0!==r?this[Q][r].push(t):this[Q][e]=[t]}has(e){return M(e=`${e}`),void 0!==V(this[Q],e)}delete(e){M(e=`${e}`);const t=V(this[Q],e);void 0!==t&&delete this[Q][t]}raw(){return this[Q]}keys(){return Y(this,"key")}values(){return Y(this,"value")}[Symbol.iterator](){return Y(this,"key+value")}}function Z(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"key+value";const r=Object.keys(e[Q]).sort();return r.map("key"===t?function(e){return e.toLowerCase()}:"value"===t?function(t){return e[Q][t].join(", ")}:function(t){return[t.toLowerCase(),e[Q][t].join(", ")]})}K.prototype.entries=K.prototype[Symbol.iterator],Object.defineProperty(K.prototype,Symbol.toStringTag,{value:"Headers",writable:!1,enumerable:!1,configurable:!0}),Object.defineProperties(K.prototype,{get:{enumerable:!0},forEach:{enumerable:!0},set:{enumerable:!0},append:{enumerable:!0},has:{enumerable:!0},delete:{enumerable:!0},keys:{enumerable:!0},values:{enumerable:!0},entries:{enumerable:!0}});const X=Symbol("internal");function Y(e,t){const r=Object.create(J);return r[X]={target:e,kind:t,index:0},r}const J=Object.setPrototypeOf({next(){if(!this||Object.getPrototypeOf(this)!==J)throw new TypeError("Value of `this` is not a HeadersIterator");var e=this[X];const t=e.target,r=e.kind,o=e.index,n=Z(t,r);return o>=n.length?{value:void 0,done:!0}:(this[X].index=o+1,{value:n[o],done:!1})}},Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]())));function ee(e){const t=Object.assign({__proto__:null},e[Q]),r=V(e[Q],"Host");return void 0!==r&&(t[r]=t[r][0]),t}Object.defineProperty(J,Symbol.toStringTag,{value:"HeadersIterator",writable:!1,enumerable:!1,configurable:!0});const te=Symbol("Response internals"),re=l.STATUS_CODES;class oe{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};R.call(this,e,t);const r=t.status||200,o=new K(t.headers);if(null!=e&&!o.has("Content-Type")){const t=q(e);t&&o.append("Content-Type",t)}this[te]={url:t.url,status:r,statusText:t.statusText||re[r],headers:o,counter:t.counter}}get url(){return this[te].url||""}get status(){return this[te].status}get ok(){return this[te].status>=200&&this[te].status<300}get redirected(){return this[te].counter>0}get statusText(){return this[te].statusText}get headers(){return this[te].headers}clone(){return new oe(U(this),{url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected})}}R.mixIn(oe.prototype),Object.defineProperties(oe.prototype,{url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}}),Object.defineProperty(oe.prototype,Symbol.toStringTag,{value:"Response",writable:!1,enumerable:!1,configurable:!0});const ne=Symbol("Request internals"),ie=d.parse,se=d.format,ae="destroy"in u.Readable.prototype;function ce(e){return"object"==typeof e&&"object"==typeof e[ne]}class ue{constructor(e){let t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};ce(e)?t=ie(e.url):(t=e&&e.href?ie(e.href):ie(`${e}`),e={});let o=r.method||e.method||"GET";if(o=o.toUpperCase(),(null!=r.body||ce(e)&&null!==e.body)&&("GET"===o||"HEAD"===o))throw new TypeError("Request with GET/HEAD method cannot have body");let n=null!=r.body?r.body:ce(e)&&null!==e.body?U(e):null;R.call(this,n,{timeout:r.timeout||e.timeout||0,size:r.size||e.size||0});const i=new K(r.headers||e.headers||{});if(null!=n&&!i.has("Content-Type")){const e=q(n);e&&i.append("Content-Type",e)}let s=ce(e)?e.signal:null;if("signal"in r&&(s=r.signal),null!=s&&!function(e){const t=e&&"object"==typeof e&&Object.getPrototypeOf(e);return!(!t||"AbortSignal"!==t.constructor.name)}(s))throw new TypeError("Expected signal to be an instanceof AbortSignal");this[ne]={method:o,redirect:r.redirect||e.redirect||"follow",headers:i,parsedURL:t,signal:s},this.follow=void 0!==r.follow?r.follow:void 0!==e.follow?e.follow:20,this.compress=void 0!==r.compress?r.compress:void 0===e.compress||e.compress,this.counter=r.counter||e.counter||0,this.agent=r.agent||e.agent}get method(){return this[ne].method}get url(){return se(this[ne].parsedURL)}get headers(){return this[ne].headers}get redirect(){return this[ne].redirect}get signal(){return this[ne].signal}clone(){return new ue(this)}}function le(e){Error.call(this,e),this.type="aborted",this.message=e,Error.captureStackTrace(this,this.constructor)}R.mixIn(ue.prototype),Object.defineProperty(ue.prototype,Symbol.toStringTag,{value:"Request",writable:!1,enumerable:!1,configurable:!0}),Object.defineProperties(ue.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0}}),le.prototype=Object.create(Error.prototype),le.prototype.constructor=le,le.prototype.name="AbortError";const de=u.PassThrough,fe=d.resolve;function he(e,t){if(!he.Promise)throw new Error("native promise missing, set fetch.Promise to your favorite alternative");return R.Promise=he.Promise,new he.Promise((function(r,o){const n=new ue(e,t),i=function(e){const t=e[ne].parsedURL,r=new K(e[ne].headers);if(r.has("Accept")||r.set("Accept","*/*"),!t.protocol||!t.hostname)throw new TypeError("Only absolute URLs are supported");if(!/^https?:$/.test(t.protocol))throw new TypeError("Only HTTP(S) protocols are supported");if(e.signal&&e.body instanceof u.Readable&&!ae)throw new Error("Cancellation of streamed requests with AbortSignal is not supported in node < 8");let o=null;if(null==e.body&&/^(POST|PUT)$/i.test(e.method)&&(o="0"),null!=e.body){const t=W(e);"number"==typeof t&&(o=String(t))}o&&r.set("Content-Length",o),r.has("User-Agent")||r.set("User-Agent","node-fetch/1.0 (+https://github.com/bitinn/node-fetch)"),e.compress&&!r.has("Accept-Encoding")&&r.set("Accept-Encoding","gzip,deflate");let n=e.agent;return"function"==typeof n&&(n=n(t)),r.has("Connection")||n||r.set("Connection","close"),Object.assign({},t,{method:e.method,headers:ee(r),agent:n})}(n),s=("https:"===i.protocol?f:l).request,a=n.signal;let c=null;const d=function(){let e=new le("The user aborted a request.");o(e),n.body&&n.body instanceof u.Readable&&n.body.destroy(e),c&&c.body&&c.body.emit("error",e)};if(a&&a.aborted)return void d();const p=function(){d(),g()},m=s(i);let y;function g(){m.abort(),a&&a.removeEventListener("abort",p),clearTimeout(y)}a&&a.addEventListener("abort",p),n.timeout&&m.once("socket",(function(e){y=setTimeout((function(){o(new A(`network timeout at: ${n.url}`,"request-timeout")),g()}),n.timeout)})),m.on("error",(function(e){o(new A(`request to ${n.url} failed, reason: ${e.message}`,"system",e)),g()})),m.on("response",(function(e){clearTimeout(y);const t=function(e){const t=new K;for(const r of Object.keys(e))if(!z.test(r))if(Array.isArray(e[r]))for(const o of e[r])H.test(o)||(void 0===t[Q][r]?t[Q][r]=[o]:t[Q][r].push(o));else H.test(e[r])||(t[Q][r]=[e[r]]);return t}(e.headers);if(he.isRedirect(e.statusCode)){const i=t.get("Location"),s=null===i?null:fe(n.url,i);switch(n.redirect){case"error":return o(new A(`redirect mode is set to error: ${n.url}`,"no-redirect")),void g();case"manual":if(null!==s)try{t.set("Location",s)}catch(e){o(e)}break;case"follow":if(null===s)break;if(n.counter>=n.follow)return o(new A(`maximum redirect reached at: ${n.url}`,"max-redirect")),void g();const i={headers:new K(n.headers),follow:n.follow,counter:n.counter+1,agent:n.agent,compress:n.compress,method:n.method,body:n.body,signal:n.signal,timeout:n.timeout};return 303!==e.statusCode&&n.body&&null===W(n)?(o(new A("Cannot follow redirect with body being a readable stream","unsupported-redirect")),void g()):(303!==e.statusCode&&(301!==e.statusCode&&302!==e.statusCode||"POST"!==n.method)||(i.method="GET",i.body=void 0,i.headers.delete("content-length")),r(he(new ue(s,i))),void g())}}e.once("end",(function(){a&&a.removeEventListener("abort",p)}));let i=e.pipe(new de);const s={url:n.url,status:e.statusCode,statusText:e.statusMessage,headers:t,size:n.size,timeout:n.timeout,counter:n.counter},u=t.get("Content-Encoding");if(!n.compress||"HEAD"===n.method||null===u||204===e.statusCode||304===e.statusCode)return c=new oe(i,s),void r(c);const l={flush:h.Z_SYNC_FLUSH,finishFlush:h.Z_SYNC_FLUSH};if("gzip"==u||"x-gzip"==u)return i=i.pipe(h.createGunzip(l)),c=new oe(i,s),void r(c);if("deflate"!=u&&"x-deflate"!=u){if("br"==u&&"function"==typeof h.createBrotliDecompress)return i=i.pipe(h.createBrotliDecompress()),c=new oe(i,s),void r(c);c=new oe(i,s),r(c)}else{e.pipe(new de).once("data",(function(e){i=8==(15&e[0])?i.pipe(h.createInflate()):i.pipe(h.createInflateRaw()),c=new oe(i,s),r(c)}))}})),function(e,t){const r=t.body;null===r?e.end():N(r)?r.stream().pipe(e):Buffer.isBuffer(r)?(e.write(r),e.end()):r.pipe(e)}(m,n)}))}he.isRedirect=function(e){return 301===e||302===e||303===e||307===e||308===e},he.Promise=global.Promise;const pe=require("yaml");process.chdir(`${__dirname}/../test/01-kubernetes`);const me=a.mkdtempSync("docker-deploy-");async function ye(e,t,r="json"){const o=await he("https://api.digitalocean.com/v2"+t,{headers:{Authorization:`Bearer ${e.digitalocean_token}`}});return"json"===r?o.json():o.text()}process.on("exit",()=>{a.rmdirSync(me,{recursive:!0})}),async function(){const e={image:w("image",{required:!0})||"",host:w("host",{required:!0})||"",app:w("app",{required:!1})||"",release:w("release",{required:!1})||"",port:w("port",{required:!1})||"80",docker_secret:w("docker_secret",{required:!1})||void 0,digitalocean_token:w("digitalocean_token",{required:!1})||void 0,digitalocean_cluster:w("digitalocean_cluster",{required:!1})||void 0};await async function(e){if(e.digitalocean_token)return async function(e){await async function(e){S("Login to digitalocean");const t=await ye(e,"/account");"unauthorized"===t.id&&(v("Invalid digitalocean_token."),process.exit());console.log("USER",t.account.email),E()}(e),e.digitalocean_cluster&&(await async function(e){S("Login to kubernetes cluster");const t=(await ye(e,"/kubernetes/clusters")).kubernetes_clusters.find(t=>t.name===e.digitalocean_cluster);t||v("Kubernetes cluster not found: "+e.digitalocean_cluster);const r=await ye(e,`/kubernetes/clusters/${t.id}/kubeconfig`,"text");a.writeFileSync(`${me}/kubeconfig`,r),console.log("LOADED kubeconfig"),E()}(e),await async function(e){S("Deployment Information");const t=e.image,r=e.port,o=e.app||function(e){return e.split("/").slice(-1)[0].split(":")[0]}(e.image),n=e.release||function(e){var t;return null!==(t=e.split(":")[1])&&void 0!==t?t:"latest"}(e.image),i=function(e,t,r){return e.replace(/\*/g,`${r}-${t}`)}(e.host,o,n);console.log(pe.stringify({app:o,release:n,host:i,image:t,port:r}).slice(0,-1)),E();const s=Object.assign({},process.env,{KUBECONFIG:`${me}/kubeconfig`});S("Deploy"),await T("helm",["upgrade","--atomic","--cleanup-on-fail","--timeout","30s","--install","--set",`nameOverride=${o}`,"--set",`host=${i}`,"--set",`image=${t}`,"--set",`port=${r}`,"--set",`app=${o}`,o+"-"+n,`${__dirname}/../k8s/helm`],{env:s}),E()}(e))}(e);v("Could not determine target for deployment.")}(e)}().catch(e=>v(e.message));
